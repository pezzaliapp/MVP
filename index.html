<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Preventivo PRO — Quoting & Margini (PWA)</title>
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icons/icon-192.png">
  <style>
    :root{
      --bg:#0b1022; --card:#111735; --ink:#f1f4ff; --muted:#9fb0d9;
      --cta:#22c55e; --line:#1d2a55; --focus:#2dd4bf;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--ink);
      background:radial-gradient(1200px 600px at 10% -10%,#162250 0%,#0b1022 40%,#070a16 100%) fixed;
      overflow-x:hidden;
    }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,16,34,.7); backdrop-filter:blur(8px);
      border-bottom:1px solid var(--line);
    }
    .bar{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.2px}
    .tag{font-size:12px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted)}
    .btn{appearance:none;border:1px solid var(--line);background:#111834;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{transform:translateY(-1px)}
    .btn-cta{background:var(--cta);border-color:#0e8a43;color:#07120c;font-weight:700}
    .btn-ghost{background:transparent}
    .select{background:#111834;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px;cursor:pointer}

    main{max-width:1200px;margin:16px auto;padding:0 12px 110px}
    .grid{display:grid;grid-template-columns:minmax(560px,1fr) 380px;gap:16px}
    @media(max-width:1100px){ .grid{ grid-template-columns:1fr } }

    .card{background:linear-gradient(180deg,rgba(28,42,85,.4),rgba(17,24,52,.7));border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 22px rgba(0,0,0,.25)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:15px}
    .section{padding:14px 16px}

    label{font-size:12px;color:var(--muted)}
    input,select{
      width:100%; padding:9px 11px; margin-top:6px;
      background:#0f1836; border:1px solid var(--line); border-radius:10px; color:var(--ink);
      font-size:14px; outline:none;
    }
    input:focus,select:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(45,212,191,.12) }

    table{width:100%; border-collapse:separate; border-spacing:0 8px; table-layout:fixed}
    th{font-size:12px;color:var(--muted);text-align:left;padding:0 8px}
    td{padding:6px 8px; font-size:14px}
    tr.item{background:#0f1836;border:1px solid var(--line)}
    tr.item td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr.item td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    td input{width:100%; font-size:14px}
    td.right input{text-align:right}
    .right{text-align:right}

    /* colonne */
    .col-img{width:96px}
    .col-desc{width:auto}
    .col-cost{width:92px}
    .col-margin{width:90px}
    .col-price{width:110px}
    .col-qty{width:72px}
    .col-disc{width:86px}
    .col-del{width:40px}

    /* descrizione leggibile */
    td input[data-k="desc"]{font-size:14px;padding:8px 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* numerici: no spinner */
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield}

    /* immagini riga */
    .thumb{width:42px;height:42px;border-radius:8px;border:1px solid var(--line);display:block;object-fit:cover;background:#0f1836}
    .thumb.placeholder{display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:16px}
    .thumbwrap{display:flex;align-items:center;gap:8px}
    .thumb-actions{display:flex;flex-direction:column;gap:4px}
    .thumb-actions .btn{padding:4px 6px;border-radius:6px;font-size:11px}

    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .totals{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}

    footer{position:fixed;bottom:0;left:0;right:0;background:rgba(11,16,34,.85);backdrop-filter:blur(8px);border-top:1px solid var(--line)}
    .foot{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .foot small{color:var(--muted)}

    /* -------- VISTA CARD -------- */
    body.layout-cards table thead{display:none}
    body.layout-cards table{border-spacing:0 10px}
    body.layout-cards tr.item{
      display:grid;
      grid-template-columns: 86px 1fr;
      grid-template-areas:
        "img desc"
        "cost cost"
        "margin margin"
        "price price"
        "qty disc"
        "del del";
      gap:10px; padding:12px; border-radius:12px;
    }
    body.layout-cards tr.item td{padding:0;border:none;background:transparent}
    body.layout-cards tr.item td:nth-child(1){grid-area:img}
    body.layout-cards tr.item td:nth-child(2){grid-area:desc}
    body.layout-cards tr.item td:nth-child(3){grid-area:cost}
    body.layout-cards tr.item td:nth-child(4){grid-area:margin}
    body.layout-cards tr.item td:nth-child(5){grid-area:price}
    body.layout-cards tr.item td:nth-child(6){grid-area:qty}
    body.layout-cards tr.item td:nth-child(7){grid-area:disc}
    body.layout-cards tr.item td:nth-child(8){grid-area:del;text-align:right}
    body.layout-cards tr.item td:nth-child(n+2):nth-child(-n+7)::before{
      display:block;color:var(--muted);font-size:12px;margin:0 0 4px;
      content: attr(data-label);
    }
    body.layout-cards td input{width:100%;font-size:16px;padding:10px 12px;border-radius:10px}
    body.layout-cards td input[data-k="desc"]{white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    body.layout-cards .thumb{width:64px;height:64px}
    body.layout-cards .thumbwrap{gap:8px}
    body.layout-cards .thumb-actions{gap:6px}
    body.layout-cards .thumb-actions .btn{padding:6px 8px;font-size:12px}
    @media (max-width:480px){
      body.layout-cards tr.item{
        grid-template-columns:1fr;
        grid-template-areas:"img" "desc" "cost" "margin" "price" "qty" "disc" "del";
      }
    }
    @media (max-width:768px){
      .bar{gap:8px}
      .btn,.select{padding:7px 10px;border-radius:9px;font-size:14px}
      h1{font-size:17px}
      footer{position:static;inset:auto;border-top:1px solid var(--line)}
      main{padding-bottom:24px}
    }

    /* PRINT-VIEW: solo layout preventivo */
    #printView{display:none}
    @media print{
      header, footer, main .grid, #resetApp, #unlockPro, #installBtn, #importCsv, #saveQuote, #printBtn, #addItem, [data-del], #viewSelect{ display:none !important; }
      body{background:#fff!important;color:#111!important;font:13px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial}
      .card{box-shadow:none;border:1px solid #ddd}
      #printView{display:block!important;padding:24px}
      .pv-wrap{max-width:900px;margin:0 auto}
      .pv-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px}
      .pv-brand h1{font-size:22px;margin:0 0 4px}
      .pv-brand small{color:#555}
      .pv-meta{text-align:right;font-size:12px;color:#444}
      .pv-meta div{margin-top:2px}
      .pv-card{border:1px solid #ddd;border-radius:8px;padding:12px;margin-bottom:14px}
      .pv-card h2{margin:0 0 8px;font-size:14px;color:#222}
      .pv-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
      .pv-field b{display:block;font-size:11px;color:#666}
      .pv-field span{font-size:13px}
      table.pv-table{width:100%;border-collapse:collapse;margin-top:6px}
      table.pv-table th,table.pv-table td{border:1px solid #ddd;padding:6px 8px;vertical-align:top}
      table.pv-table th{background:#f6f7fb;font-size:12px;text-align:left;color:#333}
      table.pv-table td.right{text-align:right}
      .pv-img{width:48px;height:48px;object-fit:cover;border:1px solid #ddd;border-radius:6px}
      .pv-totals{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
      .pv-kpi{border:1px solid #ddd;border-radius:8px;padding:10px}
      .pv-kpi b{display:block;color:#666;font-size:11px;margin-bottom:4px}
      .pv-kpi .val{font-size:16px;font-weight:700}
      .pv-notes{margin-top:10px;font-size:12px;color:#333}
      .pv-notes li{margin:4px 0}
      body.free::before{
        content:"DEMO — NON PER USO COMMERCIALE";
        position:fixed;top:35%;left:-10%;transform:rotate(-30deg);
        font-weight:800;font-size:72px;letter-spacing:2px;color:rgba(239,68,68,0.18);
        width:140%;text-align:center;z-index:9999;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <h1>Preventivo PRO</h1>
      <span class="tag">PWA • Offline</span>
      <div style="display:flex;gap:6px;align-items:center">
        <label for="viewSelect" class="tag" style="border:none;padding:0">Vista:</label>
        <select id="viewSelect" class="select">
          <option value="table">Tabella</option>
          <option value="cards">Card (mobile)</option>
        </select>
      </div>
      <button id="installBtn" class="btn btn-ghost" hidden>Aggiungi alla Home</button>
      <div style="flex:1"></div>
      <button class="btn" id="importCsv">Importa CSV</button>
      <button class="btn" id="saveQuote">Salva</button>
      <button class="btn" id="printBtn">Stampa/PDF</button>
      <button class="btn btn-cta" id="unlockPro">Sblocca PRO</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- Colonna sinistra -->
      <section class="card">
        <h2>Dati cliente & preventivo</h2>
        <div class="section" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><label>Cliente</label><input id="client" placeholder="Ragione sociale / Nome" autocomplete="organization"></div>
          <div><label>Email</label><input id="email" placeholder="email@cliente.it" type="email"></div>
          <div><label>Oggetto</label><input id="subject" placeholder="Fornitura + installazione..."></div>
          <div><label>Validità</label>
            <select id="validDays">
              <option value="15">15 giorni</option>
              <option value="30" selected>30 giorni</option>
              <option value="60">60 giorni</option>
            </select>
          </div>
        </div>
        <div class="section">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <strong>Voci di preventivo</strong>
            <button class="btn" id="addItem">+ Aggiungi riga</button>
          </div>
          <table>
            <colgroup>
              <col class="col-img"><col class="col-desc"><col class="col-cost"><col class="col-margin">
              <col class="col-price"><col class="col-qty"><col class="col-disc"><col class="col-del">
            </colgroup>
            <thead>
              <tr>
                <th>Img</th><th>Descrizione</th>
                <th class="right" id="thCost">Costo</th>
                <th class="right" id="thMargin">Margine %</th>
                <th class="right">Prezzo netto</th>
                <th class="right">Q.tà</th>
                <th class="right">Sconto %</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="items"></tbody>
          </table>
          <div class="pill" style="margin-top:8px">
            <span>CSV demo:</span>
            <button class="btn btn-ghost" id="demoCsv">carica 3 righe</button>
          </div>
        </div>
      </section>

      <!-- Colonna destra -->
      <aside class="card">
        <h2>Margini & Totali</h2>
        <div class="section">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
            <div><label>IVA %</label><input id="vat" type="number" value="22"></div>
            <div><label>Spese (trasporto, installazione)</label><input id="extra" type="number" value="0"></div>
          </div>
          <div class="totals">
            <div class="card" style="padding:12px">
              <div class="muted">Ricavi netti</div>
              <div class="mono" id="sumNetto" style="font-size:22px">€0,00</div>
              <div class="muted">Margine assoluto</div>
              <div class="mono" id="sumMargin">€0,00</div>
            </div>
            <div class="card" style="padding:12px">
              <div class="muted">Totale imponibile</div>
              <div class="mono" id="sumImponibile" style="font-size:22px">€0,00</div>
              <div class="muted">Totale IVA inclusa</div>
              <div class="mono" id="sumTotale">€0,00</div>
            </div>
          </div>
          <div style="margin-top:12px">
            <div class="pill">Target margine medio %:
              <input id="targetMargin" type="number" value="30" style="width:80px;margin-left:8px">
            </div>
            <button class="btn" id="autoPrice" style="margin-top:8px">Suggerisci prezzi per target</button>
            <p class="muted" style="margin-top:10px">
              Suggeritore: calcola i prezzi netti per ogni riga per raggiungere il <em>target</em> di margine medio.
            </p>
            <!-- specchio sola VOCE “Modalità prezzo” (quella buona) -->
            <div class="pill" style="margin-top:12px">
              <span>Modalità prezzo:</span>
              <select id="modeMirror" class="select" disabled style="opacity:.8">
                <option>Margine</option><option>Ricarico</option>
              </select>
            </div>
          </div>
        </div>
      </aside>

      <!-- PRINT VIEW (mostrata solo in stampa) -->
      <section id="printView" aria-hidden="true"></section>

    </div>
  </main>

  <footer>
    <div class="foot">
      <small>© 2025 pezzaliAPP — MIT • Dati locali nel tuo browser • Versione gratuita limitata a 1 preventivo salvato</small>
      <div><button class="btn" id="resetApp">Reset dati</button></div>
    </div>
  </footer>

  <script src="./app.js"></script>

  <!-- Switch vista + auto-detect + data-label per Card -->
  <script>
    (function(){
      const key = 'preventivo.pro.layout';
      const qp = new URLSearchParams(location.search);
      const fromQuery = qp.get('layout'); // 'table' | 'cards'
      const saved = localStorage.getItem(key);
      const ua = navigator.userAgent || '';
      const looksMobile = /iPhone|Android.+Mobile/.test(ua) || window.innerWidth < 900;
      let layout = fromQuery || saved || (looksMobile ? 'cards' : 'table');

      function applyLayout(mode){
        document.body.classList.toggle('layout-cards', mode==='cards');
        const sel = document.getElementById('viewSelect');
        if(sel) sel.value = mode;
        localStorage.setItem(key, mode);
        setTimeout(applyDataLabels, 0);
      }
      function applyDataLabels(){
        const head = Array.from(document.querySelectorAll('table thead th')).map(th => th.textContent.trim());
        document.querySelectorAll('#items tr.item').forEach(tr=>{
          const tds = tr.querySelectorAll('td');
          tds.forEach((td,idx)=>{ if(head[idx]) td.setAttribute('data-label', head[idx]); });
        });
      }
      applyLayout(layout);
      document.getElementById('viewSelect')?.addEventListener('change', e=>applyLayout(e.target.value));
      const obs = new MutationObserver(applyDataLabels);
      obs.observe(document.getElementById('items'), {childList:true, subtree:true});

      // specchio modalità prezzo (legge il TH aggiornato da app.js)
      const thMargin = document.getElementById('thMargin');
      const modeMirror = document.getElementById('modeMirror');
      const syncMode = () => {
        const txt = (thMargin?.textContent||'Margine %').includes('Ricarico') ? 'Ricarico' : 'Margine';
        if(modeMirror) modeMirror.value = txt;
        if(document.body.classList.contains('layout-cards')) applyDataLabels();
      };
      const obs2 = new MutationObserver(syncMode);
      obs2.observe(document.documentElement, {subtree:true, childList:true, characterData:true});
      syncMode();
    })();
  </script>
</body>
</html>
